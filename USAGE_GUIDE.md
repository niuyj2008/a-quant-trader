# AQuantTrader 量化策略决策支持系统 — 用户使用手册

> **版本**: v5.0 (Phase 10 AI增强版) | **最后更新**: 2026-02-19

---

## 目录

1. [系统简介](#1-系统简介)
2. [快速入门](#2-快速入门)
3. [侧边栏全局设置](#3-侧边栏全局设置)
4. [功能详解：7大功能模块](#4-功能详解7大功能模块)
   - [4.1 个股分析](#41-个股分析)
   - [4.2 持仓管理](#42-持仓管理)
   - [4.3 市场扫描](#43-市场扫描)
   - [4.4 策略回测](#44-策略回测)
   - [4.5 ETF定投](#45-etf定投)
   - [4.6 目标规划](#46-目标规划)
   - [4.7 策略实验室](#47-策略实验室)
5. [六大交易策略详解](#5-六大交易策略详解)
6. [智能策略路由器](#6-智能策略路由器)
7. [Phase 10 AI增强功能](#7-phase-10-ai增强功能)
   - [7.1 Grok AI 情绪分析](#71-grok-ai-情绪分析)
   - [7.2 行研报告共识因子](#72-行研报告共识因子)
   - [7.3 HMM 市场状态识别](#73-hmm-市场状态识别)
   - [7.4 行业轮动分析](#74-行业轮动分析)
   - [7.5 智能风控升级](#75-智能风控升级)
   - [7.6 深度学习信号过滤](#76-深度学习信号过滤)
8. [数据驱动工作台：5步流水线](#8-数据驱动工作台5步流水线)
9. [从数据到交易：系统如何帮你买卖股票](#9-从数据到交易系统如何帮你买卖股票)
10. [专业术语通俗解释](#10-专业术语通俗解释)
11. [常见问题 FAQ](#11-常见问题-faq)

---

## 1. 系统简介

### 这个系统能做什么？

AQuantTrader 是一个**量化策略决策支持系统**，简单来说，它帮助你：

- **分析股票**：输入一个股票代码，系统会从多个维度（趋势、价值、风险、动量等）给出综合评分和买卖建议
- **扫描市场**：从几百只股票中自动筛选出最值得关注的标的
- **回测策略**：用历史数据验证"如果我过去按照这个策略交易，结果会怎样"
- **管理持仓**：跟踪你的持仓盈亏，提醒你何时该加仓、减仓或止损
- **定投模拟**：模拟不同ETF定投策略的长期效果
- **目标规划**：根据你的收益目标和风险偏好，推荐合适的策略组合
- **数据驱动优化**：用真实数据训练和优化策略参数，而不是靠人为"拍脑袋"
- **🆕 AI增强分析** (Phase 10)：整合Grok AI社交情绪、华尔街分析师行研共识、HMM市场状态识别、行业轮动、智能风控、深度学习信号过滤

### 系统不做什么

- **不自动下单**：系统只提供决策建议，不会自动帮你买卖股票
- **不保证盈利**：所有建议基于历史数据和数学模型，股市有风险，投资需谨慎
- **不提供内幕信息**：所有数据来源于公开市场

### 支持的市场

| 市场 | 数据来源 | 股票代码格式 | 示例 |
|------|---------|-------------|------|
| A股（中国） | AKShare（免费） | 6位数字 | `600519`（贵州茅台）、`000001`（平安银行） |
| 美股 | yfinance（免费） | 字母代码 | `AAPL`（苹果）、`MSFT`（微软） |

---

## 2. 快速入门

### 2.1 启动系统

```bash
# 进入项目目录
cd /path/to/a-quant-trader

# 启动后端和前端
streamlit run src/web/app.py
```

系统会自动在浏览器打开 `http://localhost:8501`。

### 2.2 5分钟快速体验

1. **选择市场**：左侧边栏选择"美股"或"A股"
2. **分析一只股票**：在"个股分析"Tab中输入 `AAPL`（苹果），点击"开始分析"
3. **看结果**：系统会给出6种策略的买卖建议、评分、风险提示
4. **扫描市场**：切换到"市场扫描"Tab，点击"开始扫描"，看看系统推荐哪些股票
5. **回测验证**：切换到"策略回测"Tab，看看某个策略在过去几年的表现如何

---

## 3. 侧边栏全局设置

页面左侧的侧边栏包含影响所有功能的全局设置：

| 设置项 | 说明 | 建议 |
|-------|------|------|
| **市场选择** | A股 或 美股 | 根据你关注的市场选择 |
| **历史数据年数** | 1-10年，用于分析和回测的数据长度 | 一般选3年；做长期回测可选5-10年 |
| **量化术语通俗解释** | 可展开的术语表 | 遇到不懂的术语时展开查看 |

---

## 4. 功能详解：7大功能模块

### 4.1 个股分析

> **用途**：深入分析一只股票，获取综合买卖建议

#### 如何使用

1. 输入股票代码（A股输入如 `000001`，美股输入如 `AAPL`）
2. 选择要使用的策略（可多选，默认全选6种）
3. 点击"🚀 开始分析"

#### 你能看到什么

**基本信息卡片**：当前价格、最高价、最低价、成交量

**子Tab 1 — 策略信号**：
- **基本面评分**：像"体检报告"一样，从4个维度给股票打分
  - 盈利能力：公司赚钱的能力
  - 成长性：公司业绩增长的速度
  - 估值吸引力：当前股价是否"便宜"
  - 财务健康：公司的财务是否稳健
  - 综合评级：A+/A/B/C/D
- **策略信号概览**：6种策略各自的买卖建议一览表
  - 🟢 买入 | 🔴 卖出 | 🟡 持有
  - 信号强度（置信度越高，建议越确定）
  - 止损价（建议的最大亏损底线）
- **策略详细分析**（每个策略可展开查看）：
  - 因子雷达图：各个评分维度的得分可视化
  - 因子贡献度：哪些因素对最终结论影响最大
  - 决策理由：用文字解释为什么给出这个建议
  - 风险提示：提醒你需要注意的风险点

**子Tab 2 — 行情走势**：
- K线图（蜡烛图）：显示股价走势、均线（MA5/MA20/MA60）
- 成交量柱状图：观察交易活跃度
- RSI指标：判断是否超买（>70）或超卖（<30）
- MACD指标：判断趋势变化

**子Tab 3 — 因子研究**：
- 学术因子评分（Fama-French三因子等，详见[术语表](#10-专业术语通俗解释)）
- 因子值一览表：所有计算出的因子数值
- 因子相关性矩阵：各因子之间的关联程度热力图

**🆕 子Tab 4 — AI分析** (Phase 10)：
- **Grok AI情绪分析**：基于X(Twitter)社交媒体的实时舆情得分
  - 个股社交情绪：看多/看空信号、热门话题、讨论量
  - 市场整体情绪：市场情绪(恐慌/贪婪)、恐慌贪婪指数、重大事件
  - 板块轮动：24小时热门/冷门板块
- **华尔街行研共识**：分析师评级分布、一致目标价、盈利预测
  - 评级分布：强力买入/买入/持有/减持/卖出机构数量
  - 平均评级：1-5分(5分=强推)、覆盖机构数量
  - 一致目标价：分析师给出的平均目标价 vs 当前价的上行空间
- **市场状态识别 (HMM)**：基于隐马尔可夫模型的市场周期判断
  - 当前状态：🐂牛市/🐻熊市/↔️震荡/⚠️危机
  - 识别置信度：0-100%
  - 对策略的影响：不同市场状态下各策略的适应性调整
- **行业轮动**：基于行业动量排名识别强势/弱势板块
  - 强势行业 TOP 10：过去20日涨幅排名前列的板块
  - 弱势行业 BOTTOM 10：表现落后的板块
  - 所属行业加分：个股所在行业的动量得分对策略的增益/惩罚
- **智能风控**：增强版风险监控
  - ATR自适应止损：基于波动率(ATR)动态调整止损价
  - 持仓相关性监控：检测高度相关的持仓对(相关性>0.8)
  - 黑天鹅检测：3-sigma极端波动预警
- **深度学习过滤器**：已训练LSTM/Transformer模型对策略信号的二次验证
  - 模型类型：LSTM或Transformer
  - 过滤逻辑：策略说买入但DL预测下跌→降级为持有
  - 置信阈值：DL预测置信度低于60%时不过滤

#### 通俗理解

把"个股分析"想象成给股票做一次**全面体检**：
- 基本面评分 = 血常规、肝功能等基础体检
- 策略信号 = 6位不同科室的医生分别给出诊断意见
- 行情走势 = 心电图、B超等影像学检查
- 因子研究 = 深度学术分析报告

---

### 4.2 持仓管理

> **用途**：记录和管理你的股票持仓，获取调仓建议

#### 子Tab 1 — 持仓总览

- **添加持仓**：输入股票代码、买入价格、持仓数量
- **持仓仪表盘**：
  - 总市值、总成本、浮动盈亏（赚了还是亏了）
  - 持仓数量、盈利/亏损个数
  - 行业分布饼图、Top 5 持仓
- **调仓计划**：根据策略建议自动生成买入/卖出/加仓/减仓操作清单

#### 子Tab 2 — 策略分析

选择一个策略后，系统会逐一分析你的每只持仓：
- 当前建议（继续持有 / 减仓 / 清仓）
- 触发止损提醒（亏损超过10%时）
- 触发止盈提醒（盈利超过30%时）

#### 子Tab 3 — 交易记录

记录所有买入/卖出操作的明细和绩效统计。

#### 子Tab 4 — 信号日志

自动记录系统产生的每一次交易信号，并跟踪信号发出后的**实际表现**：
- 5天后实际涨跌
- 10天后实际涨跌
- 20天后实际涨跌

这让你可以回头看：系统的建议到底准不准？

#### 通俗理解

"持仓管理"就像一个**投资管家**：
- 帮你记账（买了什么、花了多少、赚了亏了）
- 帮你巡检（哪些该卖、哪些该加仓）
- 帮你复盘（之前的建议效果如何）

---

### 4.3 市场扫描

> **用途**：从整个市场中筛选出最值得关注的股票

#### 如何使用

1. 选择策略（或使用"智能路由"让系统根据每只股票的状态自动匹配最适合的策略）
2. 设置最低置信度和推荐数量
3. 点击"🔎 开始扫描"

#### 你能看到什么

- **推荐列表**：按综合得分排序的股票清单，显示信号、得分、现价、止损价、核心理由
- **Top 5 详细分析**：每只推荐股票可展开查看详细因子分析
- **策略胜率对比**：各策略的历史推荐胜率对比（胜率低于45%的会标记警告）
- **历史推荐回顾**：回顾之前推荐的股票后来的表现

#### 通俗理解

"市场扫描"就像一个**自动化选股助手**，它替你浏览几百只股票，帮你从海量信息中找到最值得关注的几只。

---

### 4.4 策略回测

> **用途**：用历史数据验证策略——"如果我过去按这个策略交易，结果会怎样？"

#### 如何使用

1. 输入回测的股票代码
2. 选择策略、日期范围
3. 选择报告类型：
   - **标准报告**：6个核心指标 + 收益曲线
   - **专业报告**：27+个专业指标 + 月度热力图 + 回撤分析

#### 标准报告包含

| 指标 | 通俗含义 |
|------|---------|
| 总收益率 | 这段时间一共赚了（亏了）百分之多少 |
| 年化收益率 | 换算成"一年能赚多少"的标准化收益率 |
| 夏普比率 | 承受的风险和获得的收益是否"划算"（>1.0 很好，>2.0 优秀） |
| 最大回撤 | 从最高点到最低点的最大亏损幅度（越小越好） |
| 买入周数 | 总共发出了多少次买入信号 |
| 持仓胜率 | 买入后赚钱的比例 |

#### 专业报告额外包含

- **收益指标**：CAGR（复合年增长率）、日均收益、正收益月占比
- **风险指标**：VaR（风险价值）、CVaR（条件风险价值）、下行波动率
- **风险调整收益**：Sortino比率、Calmar比率、Alpha、Beta
- **交易指标**：胜率、盈亏比、最大连续盈利/亏损
- **可视化**：权益曲线、月度收益热力表、Top 5 回撤事件

#### 通俗理解

"策略回测"就像给策略做一次**模拟考试**：用过去几年的真实历史数据，模拟如果按照这个策略操作，会赚多少钱、最大能亏多少、整体表现如何。分数越高，说明策略在历史上越有效（但不保证未来也一样）。

---

### 4.5 ETF定投

> **用途**：模拟不同ETF定投策略的长期效果

#### 三种定投策略

| 策略 | 通俗解释 | 适合谁 |
|------|---------|-------|
| **定期定额（DCA）** | 每周/每两周/每月固定投入相同金额，"不管涨跌都买"。最简单，适合懒人。 | 入门投资者，不想花精力择时 |
| **价值平均（VA）** | 设定一个目标增长值，每期投入不同的金额使账户达到目标。涨多了少买，跌多了多买。 | 愿意稍微花点心思、追求更好效果的投资者 |
| **智能再平衡** | 定期调整投入比例，让收益曲线更加平滑。 | 追求稳健收益的投资者 |

#### 你能看到什么

- **5个核心指标**：总投入、最终市值、总收益率、IRR（真实年化收益率）、定投次数
- **累计投入 vs 市值对比图**：直观看到定投的"钱生钱"效果
- **买入价格散点图**：每次定投的买入价格 + 平均成本线

#### 通俗理解

> **IRR（内部收益率）**：因为定投每次投入的时间不同，不能简单用"总收益 / 总投入"来算收益率。IRR 考虑了每笔钱投入的时间长短，给出一个更真实的年化收益率。比如你定投3年，IRR=8%意味着平均每年赚8%。

---

### 4.6 目标规划

> **用途**：根据你的投资目标和风险偏好，推荐合适的策略

#### 如何使用

1. 设置投资期限（1-10年）
2. 设置目标年化收益（5%-50%）
3. 选择风险承受能力：保守 / 稳健 / 激进
4. 输入初始资金和月定投金额
5. 点击"生成推荐方案"

#### 你能看到什么

- **策略推荐列表**：按匹配度排序，显示4个维度的评分
  - 收益匹配：策略的历史收益是否接近你的目标
  - 风险控制：策略的风险水平是否在你的承受范围内
  - 稳定性：策略表现的一致性
  - 期限匹配：策略是否适合你的投资期限
- **蒙特卡洛模拟**：
  - 1000次随机模拟未来可能的走势
  - 显示最好、最差、中间的可能结果
  - 计算"达成目标的概率"
  - 最终资产分布图

#### 通俗理解

> **蒙特卡洛模拟**：想象你掷骰子1000次，每次代表未来一种可能的市场走势。有些次赚得多，有些次亏得多。看看1000次中有多少次能达成你的目标，这个比例就是"成功概率"。比如显示60%，意味着如果未来的市场和历史类似，你有60%的可能性达成目标。

---

### 4.7 策略实验室

> **用途**：高级分析工具，用于策略优化、因子验证和机器学习实验

包含5个子模块：

#### 子Tab 1 — ML算法对比

比较4种机器学习算法预测股票的效果：

| 算法 | 通俗解释 |
|------|---------|
| LightGBM | 一种高效的"决策树"算法，像一位经验丰富的分析师，通过一系列"如果...那么..."的规则做判断 |
| XGBoost | 和LightGBM类似，但更注重准确性，计算速度稍慢 |
| RandomForest | "随机森林"——让很多"决策树"各自投票，少数服从多数 |
| LogisticRegression | 最简单的模型，用于做基准对比（相当于考试中的"及格线"） |

显示每个算法的准确率、精确率、召回率、F1分数等，帮你判断哪个算法最适合当前的数据。

#### 子Tab 2 — 策略集成

将多个策略"组队"，让它们联合给出建议：

| 集成方法 | 通俗解释 |
|---------|---------|
| 投票法 | 6个策略各投一票，少数服从多数 |
| 加权法 | 给表现好的策略更大的话语权 |
| 动态加权法 | 根据最近的市场表现动态调整每个策略的权重 |

#### 子Tab 3 — 因子有效性验证

验证各个"因子"（评分指标）到底有没有预测能力。详见[第7章](#7-数据驱动工作台5步流水线)。

#### 子Tab 4 — 策略冗余度分析

检查6个策略之间是否存在"重复"——如果两个策略的信号高度相似（相关性>0.8），说明它们在做差不多的事情，保留一个就够了。

#### 子Tab 5 — 数据驱动工作台

系统最核心的高级功能，通过5步流水线用数据训练和优化策略。详见[第7章](#7-数据驱动工作台5步流水线)。

---

## 5. 六大交易策略详解

系统内置6种交易策略，每种策略适合不同的市场环境和投资风格：

### 5.1 多因子均衡策略（balanced）

> **一句话理解**：像"全科医生"，从多个角度均衡打分，追求稳健回报

- **风险等级**：中等 ⭐⭐⭐
- **适合场景**：大多数市场环境，适合不确定该选哪个策略的投资者
- **投资周期**：中长期

**主要评分维度**：
| 因子 | 权重 | 通俗含义 |
|------|------|---------|
| 20日动量 | 15% | 最近20天股价的涨跌幅度 |
| RSI | 10% | 股票是否被过度买入或卖出 |
| 均线趋势 | 20% | 股价是在短期均线之上（上涨趋势）还是之下（下跌趋势） |
| 价格位置 | 10% | 当前价格处于近期高低范围的什么位置 |
| MACD | 15% | 趋势的变化方向和力度 |
| 量比 | 10% | 今天的成交量比平时大还是小 |
| 波动率 | 10% | 股价每天的波动幅度大不大 |
| PE估值 | 10% | 股价相对于公司盈利是贵还是便宜 |
| 🆕 AI舆情 | 5% | Grok AI分析X平台社交媒体的个股情绪得分 |
| 🆕 AI市场情绪 | 3% | Grok AI分析的整体市场情绪(恐慌/贪婪指数) |
| 🆕 行研共识评级 | 2% | 华尔街分析师一致评级 |

**Phase 10增强**：均衡策略整合AI情绪(8%)和行研(2%)，总计外部因子权重10%

**决策规则**：综合得分 ≥65 → 买入 | ≤35 → 卖出 | 中间 → 持有
**止损线**：买入价下跌8%

---

### 5.2 动量趋势策略（momentum）

> **一句话理解**：像"冲浪者"，追随趋势，"强者恒强"

- **风险等级**：中高 ⭐⭐⭐⭐
- **适合场景**：明显的上涨或下跌趋势中
- **投资周期**：中短期

**核心思想**：正在涨的股票往往会继续涨，正在跌的往往会继续跌。当多个时间段的涨跌方向一致时（短期、中期、长期都在涨），说明趋势很强。

**主要评分维度**：
| 因子 | 权重 | 通俗含义 |
|------|------|---------|
| 5日动量 | 20% | 最近一周的涨跌 |
| 20日动量 | 25% | 最近一个月的涨跌 |
| 60日动量 | 15% | 最近三个月的涨跌 |
| 均线趋势 | 15% | 均线是否呈多头排列 |
| MACD动量 | 15% | MACD柱状图的方向 |
| 成交量确认 | 10% | 上涨时成交量是否放大 |

**特殊条件**：只有当短期、中期趋势方向一致时才会发出买入信号
**止损线**：买入价下跌10%

---

### 5.3 价值投资策略（value）

> **一句话理解**：像"精明的买家"，专找被低估的好公司，买"便宜货"

- **风险等级**：低 ⭐⭐
- **适合场景**：市场恐慌或个股被错杀时
- **投资周期**：长期（1年以上）

**核心思想**：寻找价格低于内在价值的好公司。就像打折季去买名牌——东西还是那个好东西，只是价格暂时变便宜了。

**主要评分维度**：
| 因子 | 权重 | 通俗含义 |
|------|------|---------|
| PE估值 | 20% | 股价 / 每股收益。越低说明越"便宜"。低于15倍通常被认为低估 |
| PB估值 | 15% | 股价 / 每股净资产。越低说明越接近公司的"清算价值" |
| ROE盈利能力 | 20% | 公司用股东投入的钱赚钱的效率。越高越好，>10%为优秀 |
| 营收增长 | 10% | 公司营业收入的增长速度 |
| 毛利率 | 10% | 公司产品的利润空间 |
| 波动率 | 10% | 偏好低波动 |
| 价格位置 | 15% | 偏好价格处于较低位置 |
| 🆕 行研共识评级 | 5% | 华尔街分析师的一致评级(1-5分)，卖方偏差修正后得分 |
| 🆕 目标价空间 | 5% | 分析师一致目标价相对当前价的上行空间 |
| 🆕 评级变动动量 | 5% | 近30天内机构上调/下调评级的净变化 |

**Phase 10增强**：价值策略最依赖行研共识(总权重15%)，因为长期投资需要基本面确认

**止损线**：买入价下跌10%

---

### 5.4 低波动防御策略（low_vol）

> **一句话理解**：像"乌龟赛跑"，虽然涨得慢，但很少大跌

- **风险等级**：低 ⭐⭐
- **适合场景**：市场不确定性高、想要"防守"的时候
- **投资周期**：中长期

**核心思想**：选择价格波动小的股票。这类股票涨的时候可能涨得不多，但跌的时候也跌得少。学术研究表明，长期来看低波动股票的风险调整后收益反而更好。

**主要评分维度**：
| 因子 | 权重 | 通俗含义 |
|------|------|---------|
| 波动率 | 25% | 股价的日常波动幅度，越低越好 |
| 下行风险 | 20% | 只看下跌时的波动，衡量"最坏情况" |
| ATR | 15% | 平均真实波动幅度，越低越平稳 |
| 稳定性 | 15% | 价格走势的稳定程度 |
| 稳定上涨 | 15% | 在低波动的基础上是否有稳定的上涨趋势 |
| 低波+正趋势 | 10% | 波动低且方向向上（最理想状态） |

**止损线**：买入价下跌5%（比其他策略更严格，因为低波动股票不应该大跌）

---

### 5.5 均值回归策略（reversion）

> **一句话理解**：像"抄底猎手"，别人恐惧时贪婪，别人贪婪时恐惧

- **风险等级**：高 ⭐⭐⭐⭐⭐
- **适合场景**：震荡市（股价在一个范围内上下波动）
- **投资周期**：短期

**核心思想**：股价偏离正常水平太多后，往往会"回归均值"。就像橡皮筋——拉得越远，弹回去的力量越大。当股票严重超卖（跌过头）时买入，超买（涨过头）时卖出。

**主要评分维度**：
| 因子 | 权重 | 通俗含义 |
|------|------|---------|
| RSI超卖 | 25% | RSI<30表示严重超卖（跌过头了） |
| 均线偏离 | 20% | 股价偏离均线的程度——偏离越大，回归可能性越大 |
| 价格位置 | 15% | 当前处于近期最低价附近更好 |
| 短期回撤 | 20% | 短期内跌了多少 |
| 缩量 | 10% | 下跌时成交量萎缩（说明抛售力量在减弱） |
| 波动率 | 10% | 波动大意味着更大的回归空间 |

**特殊条件**：买入需要 RSI < 35（严重超卖）
**风险提示**：这是最激进的策略，有"接飞刀"的风险
**止损线**：买入价下跌8%

---

### 5.6 技术突破策略（breakout）

> **一句话理解**：像"猎豹伏击"，等待股价突破关键阻力位时迅速出手

- **风险等级**：中高 ⭐⭐⭐⭐
- **适合场景**：股价经过长时间盘整后即将选择方向时
- **投资周期**：中短期

**核心思想**：当股价向上突破一个重要的价格关口（阻力位），并且有大量成交作为"确认"，这通常意味着新一轮上涨的开始。

**主要评分维度**：
| 因子 | 权重 | 通俗含义 |
|------|------|---------|
| 阻力位突破 | 25% | 股价是否接近或突破了重要的价格上限 |
| 成交量确认 | 20% | 突破时成交量是否明显放大（量比>1.5） |
| 短期动量 | 15% | 最近几天的上涨力度 |
| MACD信号 | 15% | 趋势指标是否确认方向 |
| 均线支撑 | 15% | 股价是否在重要均线之上 |
| RSI空间 | 10% | RSI是否还有上涨空间（不能已经超买） |

**止损线**：买入价下跌7%

---

### 六大策略对比总结

| 策略 | 风险 | 核心理念 | 适合市场 | 适合投资者 |
|------|------|---------|---------|-----------|
| 多因子均衡 | 中 | 均衡打分 | 大多数情况 | 稳健型，不确定选哪个策略 |
| 动量趋势 | 中高 | 追涨杀跌 | 明确趋势 | 偏进攻型，能接受波动 |
| 价值投资 | 低 | 低买高卖 | 恐慌或低估 | 长线投资者，有耐心 |
| 低波动防御 | 低 | 少亏少赚 | 不确定市场 | 保守型，追求稳定 |
| 均值回归 | 高 | 反转抄底 | 震荡市 | 激进型，经验丰富 |
| 技术突破 | 中高 | 突破伏击 | 盘整后突破 | 活跃交易者，反应快 |

---

## 6. 智能策略路由器

### 它是什么？

策略路由器是一个**自动推荐系统**，它分析当前股票的市场状态（趋势强弱、超买超卖、波动大小等），然后推荐最适合的策略。你不需要自己判断应该用哪个策略，系统会帮你选择。

### 推荐逻辑

| 市场状态 | 推荐策略 | 原因 |
|---------|---------|------|
| 趋势很强（ADX>25），多个时间段一致上涨 | 动量趋势 | 趋势明确时应该"顺势而为" |
| 震荡市场（ADX<20），RSI超卖（<35） | 均值回归 | 股价跌过头了，可能反弹 |
| 股价接近阻力位，且成交量放大 | 技术突破 | 可能即将突破，伏击买入 |
| 波动率极低（<1.5%），无明显趋势 | 低波动防御 | 市场平静时适合防守 |
| 低PE（<15）+ 高ROE（>10%） | 价值投资 | 好公司被低估了 |
| 以上都不明显 | 多因子均衡 | 默认使用最稳健的策略 |

### 排除机制

路由器还会"排除"不适合当前环境的策略：
- 趋势很强时 → 排除均值回归（趋势中做反转容易亏钱）
- 波动率很高时 → 排除低波动策略（已经不低波动了）
- RSI已经超买时 → 排除动量策略（涨太多了不宜追）
- 没有基本面数据时 → 排除价值策略（无法判断估值）

### 🆕 Phase 10 增强：HMM市场状态识别

传统路由器仅基于单股票的技术指标判断，Phase 10引入**隐马尔可夫模型(HMM)**分析大盘指数，识别当前市场处于哪个宏观状态：

| 市场状态 | 特征 | 策略调整 |
|---------|------|---------|
| 🐂 牛市 (Bull) | 趋势向上，波动率低，成交量稳定 | 动量策略×1.2，均值回归×0.7 |
| 🐻 熊市 (Bear) | 趋势向下，恐慌情绪蔓延 | 价值策略×1.1，低波动×1.15，动量×0.6 |
| ↔️ 震荡 (Sideways) | 无明显趋势，ADX<20 | 均值回归×1.3，突破×1.1 |
| ⚠️ 危机 (Crisis) | 极端波动(VIX>40)，3-sigma大跌 | 低波动×1.5，其他策略×0.5 |

**识别原理**：
- 输入120天的指数行情(收益率、波动率、成交量)
- HMM学习4个隐藏状态的转移概率
- 数据不足时自动降级到规则引擎(基于ADX/波动率/动量/RSI的阈值判断)

**在界面中的体现**：
- 个股分析 → AI分析Tab → 市场状态识别面板
- 显示当前状态、置信度、对各策略的影响系数

---

## 7. Phase 10 AI增强功能

> **版本**: v5.0新增 | **核心理念**: 整合外部信息源(AI+行研+宏观)，补全纯价量分析的维度盲区

Phase 10在原有6大策略的基础上,引入6大AI增强模块,将决策维度从"技术面+基本面"扩展到"技术+基本+情绪+共识+宏观+深度学习",实现全方位智能决策支持。

---

### 7.1 Grok AI 情绪分析

#### 它是什么？

基于 X (原Twitter) 的 **Grok AI** 大语言模型,实时分析社交媒体上的投资者情绪和市场讨论,将非结构化文本转化为可量化的因子得分。

#### 数据来源

- **个股舆情**: Grok搜索X平台上关于特定股票的讨论帖子(最近24-48小时)
- **市场情绪**: Grok搜索宏观经济、美联储、行业板块等整体市场话题
- **结构化输出**: 使用JSON Schema强制Grok返回标准格式数据(而非自然语言)

#### 个股情绪因子 (权重5%)

Grok分析返回的结构化数据:

```json
{
  "sentiment_score": 0.65,          // -1(极度看空) ~ +1(极度看多)
  "confidence": 0.82,               // 0-1, 基于样本量和一致性
  "post_count": 47,                 // 讨论量(样本数)
  "key_topics": ["earnings", "AI"], // 热门话题标签
  "bullish_signals": [              // 看多信号
    "Strong guidance from management",
    "Partnerships announced"
  ],
  "bearish_signals": [              // 看空信号
    "Insider selling reported"
  ],
  "event_risk": "medium"            // none/low/medium/high
}
```

**评分逻辑**:
- `sentiment_score = 0.8, confidence = 0.9` → 得分 85/100 (强烈看多)
- `sentiment_score = -0.6, confidence = 0.7` → 得分 22/100 (看空)
- `sentiment_score = 0.5, confidence = 0.2` → 得分 55/100 (置信度低,向中性衰减)
- `post_count < 5` → 样本不足,得分向50衰减

**接入策略**:
- `BalancedMultiFactorStrategy`: 作为"AI舆情"因子,权重5%
- `MomentumTrendStrategy`: 可选接入(动量+情绪共振时加强信号)

#### 市场情绪因子 (权重3%)

Grok分析整体市场氛围:

```json
{
  "market_mood": "optimistic",        // panic/anxious/neutral/optimistic/euphoria
  "fear_greed_estimate": 65,          // 0-100, 类似VIX恐慌指数
  "key_events": [                     // 24h重大事件
    "Fed meeting minutes released",
    "Inflation data beats expectation"
  ],
  "sector_rotation": {                // 板块轮动
    "hot_sectors": ["Technology", "Healthcare"],
    "cold_sectors": ["Energy", "Materials"]
  },
  "risk_alerts": []                   // 系统性风险预警
}
```

**逆向使用** (参考巴菲特"别人恐惧我贪婪"):
- `market_mood = "panic"` → 得分 90/100 (市场恐慌=买入机会)
- `market_mood = "euphoria"` → 得分 10/100 (市场狂热=警惕风险)
- `fear_greed_estimate = 15` (极度恐慌) → 得分 85/100

**接入策略**:
- `BalancedMultiFactorStrategy`: 作为"AI市场情绪"因子,权重3%
- `StrategyRouter`: 影响市场状态判断(恐慌时提升均值回归权重)

#### 成本控制

- **每日预算**: 默认 $5 USD (可在`config/settings.yaml`调整)
- **缓存机制**: 个股情绪4小时、市场情绪1小时、深度分析24小时
- **模型选择**: 批量情绪用 `grok-3-mini` (便宜快速), 深度分析用 `grok-4-1` (准确率高)
- **优雅降级**: API不可用或预算耗尽时,自动跳过Grok因子,不影响策略运行

#### 如何启用

1. 获取 xAI API Key: https://console.x.ai/
2. 设置环境变量: `export XAI_API_KEY="xai-xxxxx"`
3. 修改 `config/settings.yaml`:
   ```yaml
   grok:
     enabled: true
     max_daily_cost_usd: 5.0
   ```
4. 重启系统,在"个股分析 → AI分析Tab"查看结果

---

### 7.2 行研报告共识因子

#### 它是什么？

整合华尔街**顶级投行分析师**的评级、目标价、盈利预测等结构化数据,将"卖方研究"转化为量化因子。

#### 数据来源

- **美股**: yfinance内置的 `ticker.recommendations` / `analyst_price_targets` 等API
  - 数据覆盖: Goldman Sachs、Morgan Stanley、J.P. Morgan等主流投行
  - 更新频率: 实时更新,系统24小时缓存
- **A股**: AKShare免费API `stock_profit_forecast_em` (盈利预测) + `stock_comment_detail_zlkp_jgcyd_em` (机构活跃度)
  - 数据质量相对美股较弱,但可作为辅助参考

#### 四大行研因子

##### (1) 一致预期评级 (权重4-6%)

**数据来源**: yfinance `ticker.recommendations`

| 分析师评级 | 标准化分数 | 示例投行 |
|-----------|-----------|---------|
| Strong Buy / Top Pick | 5 | Goldman Sachs "Conviction Buy" |
| Buy / Overweight / Outperform | 4 | Morgan Stanley "Overweight" |
| Hold / Neutral / Equal-Weight | 3 | J.P. Morgan "Neutral" |
| Underperform / Underweight | 2 | Credit Suisse "Underperform" |
| Sell / Strong Sell | 1 | Rare (卖方很少给Sell评级) |

**评分逻辑**:
1. 筛选近90天评级,时间衰减加权(0-30天权重1.0, 31-60天权重0.7, 61-90天权重0.4)
2. 每家券商只取最新一条(去重)
3. 加权平均得到 1-5 分的一致评级
4. **卖方偏差修正**: 由于分析师系统性偏乐观(经验均值3.55而非理论3.0),得分减去0.55后映射到0-100
   - 修正前: `raw_avg = 3.55` → 未修正得分65 (虚高)
   - 修正后: `corrected_avg = 3.0` → 得分50 (真实中性)

**样本不足处理**:
- 评级数量 < 3 → 返回50分(中性)
- 全部为Hold → 返回50分

##### (2) 目标价上行空间 (权重4-5%)

**数据来源**: yfinance `ticker.analyst_price_targets`

```json
{
  "current": 177.5,   // 当前股价
  "low": 160.0,       // 分析师最低目标价
  "high": 210.0,      // 分析师最高目标价
  "mean": 185.3,      // 平均目标价
  "median": 183.0     // 中位数目标价
}
```

**评分逻辑**:
- `upside = (median - current) / current`
- 分段映射:
  - upside > 40% → 95分 (极度低估)
  - upside 25-40% → 85分
  - upside 15-25% → 75分
  - upside 5-15% → 60分
  - upside 0-5% → 50分 (合理定价)
  - downside 0-10% → 40分
  - downside 10-20% → 25分
  - downside > 20% → 10分 (极度高估)

**分歧度校验**:
- 如果 `(high - low) / current > 100%` → 分析师分歧过大,得分向50衰减30%

##### (3) 评级变动动量 ⭐ (权重3-5%)

**学术依据**: Womack (1996) 证实评级变动后股价有显著漂移效应

**数据来源**: yfinance `recommendations['action']` 字段

| action值 | 含义 | 示例 |
|---------|------|------|
| "upgrade" | 上调评级 | Hold → Buy |
| "downgrade" | 下调评级 | Buy → Hold |
| "initiated" | 首次覆盖 | 新发布研报 |
| "reiterated" | 重申评级 | 维持Buy不变 |

**评分逻辑**:
1. 统计近30天内的 `upgrades` 和 `downgrades` 次数
2. `net_change = upgrades - downgrades`
3. 分段映射:
   - net_change ≥ 4 → 95分 (机构集体上调)
   - net_change = 3 → 85分
   - net_change = 2 → 75分
   - net_change = 1 → 65分
   - net_change = 0 → 50分
   - net_change = -1 → 35分
   - net_change = -2 → 25分
   - net_change ≤ -3 → 10分 (机构集体下调)
4. **时间加权**: 7天内的变动权重 ×1.5

**这是最有预测力的行研因子**(IC > 0.4),因为评级变动是分析师"用真金白银"表达观点变化的信号。

##### (4) 机构覆盖广度 (权重0-2%)

**数据来源**: yfinance `recommendations['firm']` 字段去重

**评分逻辑**:
- 统计近180天覆盖该股的独立券商数量
- 分段映射:
  - \> 25家 → 80分 (超高关注度)
  - 20-25家 → 70分
  - 15-20家 → 65分
  - 10-15家 → 55分
  - 5-10家 → 45分
  - < 5家 → 35分 (低覆盖)

**策略差异化使用**:
- Value策略: **反转使用**(低覆盖=高分,被忽视的价值股)
- Momentum/Breakout策略: 正向使用(高覆盖=流动性好)

#### 接入策略

| 策略 | 行研因子总权重 | 说明 |
|------|--------------|------|
| ValueInvestStrategy | 15% | 价值策略最依赖行研共识(共识评级5% + 目标价5% + 变动动量5%) |
| BalancedMultiFactorStrategy | 10% | 均衡策略接入行研(共识评级6% + 目标价4%) |
| 其他策略 | 0% | 动量/低波动/均值回归/突破策略不接入行研因子 |

**设计原则**: 外部因子总权重≤25%,单一因子≤10%,核心仍是价量+基本面。

#### 可解释性输出

在 `DecisionReport` 的推理文本中自动生成:

```
买入理由:
- 华尔街分析师一致看好(共识得分78, 覆盖机构23家)
- 一致目标价较当前价上行23%, 空间充足
- 近30天有5家机构上调评级(动量得分82)
```

---

### 7.3 HMM 市场状态识别

#### 它是什么？

基于**隐马尔可夫模型(Hidden Markov Model)**,通过分析大盘指数的收益率分布、波动率、成交量等特征,自动识别市场处于哪个宏观周期,并据此调整各策略的权重。

#### 原理简述

**隐马尔可夫模型**假设市场有4个"隐藏状态"(牛市/熊市/震荡/危机),每个状态有不同的收益率分布特征:
- 牛市: 正收益为主,波动率低
- 熊市: 负收益为主,波动率中等
- 震荡: 收益率接近0,波动率中等
- 危机: 大幅负收益,波动率极高

模型通过历史数据学习:
1. **状态转移概率**: 从牛市转到熊市的概率、从震荡转到危机的概率等
2. **观测概率**: 在牛市状态下,出现某个收益率的概率

然后根据最近的市场表现,推断当前最可能处于哪个状态。

#### 四大市场状态

| 状态 | 特征 | 策略调整系数 |
|------|------|-------------|
| 🐂 **牛市** (Bull) | 趋势向上,低波动,成交量稳定 | 动量×1.2, 均值回归×0.7 |
| 🐻 **熊市** (Bear) | 趋势向下,恐慌情绪 | 价值×1.1, 低波动×1.15, 动量×0.6 |
| ↔️ **震荡** (Sideways) | 无明显趋势,ADX<20 | 均值回归×1.3, 突破×1.1 |
| ⚠️ **危机** (Crisis) | VIX>40, 3-sigma大跌 | 低波动×1.5, 其他×0.5 |

**示例**: 如果HMM识别当前为牛市,某股票的动量策略原始得分70分,经过调整后变为 `70 × 1.2 = 84分`,排名上升;而均值回归原始得分65分,调整后变为 `65 × 0.7 = 45.5分`,排名下降。

#### 识别流程

```python
# 1. 输入120天大盘指数数据
index_df = fetcher.get_daily("^GSPC", market="US", years=1)  # S&P 500

# 2. HMM检测
from src.factors.macro_factors import MarketRegimeHMM
detector = MarketRegimeHMM()
regime, confidence, description = detector.detect_regime(index_df)

# 3. 输出
print(regime)          # MarketRegime.BULL
print(confidence)      # 0.87 (87%置信度)
print(description)     # "牛市(HMM): 趋势向上,波动率低..."

# 4. 应用到策略路由
modifier = detector.get_strategy_modifier(regime, 'momentum')
print(modifier)        # 1.2 (牛市中动量策略加成20%)
```

#### 降级机制

- **数据不足** (< 60天): 自动降级到规则引擎
- **hmmlearn未安装**: 自动降级到规则引擎
- **规则引擎逻辑**:
  ```python
  if adx > 25 and m20 > 0.08 and rsi > 50:
      return MarketRegime.BULL
  elif adx > 25 and m20 < -0.08 and rsi < 50:
      return MarketRegime.BEAR
  elif vol20 > 0.05 and m20 < -0.15:
      return MarketRegime.CRISIS
  else:
      return MarketRegime.SIDEWAYS
  ```

#### 在界面中的体现

**位置**: 个股分析 → AI分析Tab → 市场状态识别面板

**显示内容**:
- 当前状态: 🐂 牛市 / 🐻 熊市 / ↔️ 震荡 / ⚠️ 危机
- 识别置信度: 0-100%
- 描述文本: "基于隐马尔可夫模型识别,当前S&P 500处于牛市状态(置信度87%),趋势向上..."

---

### 7.4 行业轮动分析

#### 它是什么？

通过计算所有行业板块的**动量排名**,识别当前强势/弱势行业,为个股选择提供行业维度的增益/惩罚。

#### 核心理念

学术研究表明,**行业动量**是除个股动量外最强的因子之一。同一行业内的股票往往同涨同跌,选择强势行业内的股票,成功概率更高。

#### 数据来源

**A股**:
- AKShare `stock_board_industry_name_em()`: 获取所有行业板块的实时涨跌幅
- 返回: 板块名称、今日涨跌幅、领涨股等

**美股**:
- Sector ETF代理法: 使用11只行业ETF代表11个行业
  - XLK (Technology)
  - XLF (Financial)
  - XLE (Energy)
  - XLV (Healthcare)
  - XLY (Consumer Discretionary)
  - XLP (Consumer Staples)
  - XLU (Utilities)
  - XLI (Industrial)
  - XLB (Materials)
  - XLRE (Real Estate)
  - XLC (Communication)
- 计算各ETF过去20日收益率,排名即为行业强弱

#### 行业得分计算

```python
from src.factors.industry_factors import IndustryRotationFactor

factor = IndustryRotationFactor()
scores = factor.compute_industry_scores(market="US", lookback_days=20)

# 返回示例:
# {
#   'Technology': 87.3,      # 强势行业
#   'Healthcare': 72.1,
#   'Financial': 54.2,       # 中性
#   'Energy': 23.5,          # 弱势行业
#   'Materials': 18.7
# }
```

**得分逻辑**: 百分位排名
- 87.3分 = 该行业涨幅在所有行业中排名前13%
- 18.7分 = 该行业涨幅在所有行业中排名后82%

#### 个股行业增益

```python
# 获取股票所属行业
from src.factors.industry_factors import IndustryClassifier
classifier = IndustryClassifier()
industry = classifier.get_industry("AAPL", market="US")
# 返回: "Technology"

# 计算行业增益分
bonus = factor.get_stock_industry_bonus(
    code="AAPL",
    industry="Technology",
    industry_scores=scores
)
# 返回: +7.5 (Technology得分87 → 增益+7.5分)
```

**增益公式**:
```
bonus = (行业得分 - 50) / 50 × 10
范围: -10 到 +10
```

示例:
- 行业得分 90 → bonus = +8
- 行业得分 50 → bonus = 0 (中性)
- 行业得分 20 → bonus = -6 (惩罚)

#### 接入策略

当前版本**未直接接入6大策略的因子打分**,而是作为:
1. **市场扫描增强**: 优先推荐强势行业内的股票
2. **AI分析面板展示**: 让用户了解所选股票的行业位置
3. **未来扩展**: Phase 10.3预留了`IndustryRotationStrategy`(第7个策略)的接口

#### 在界面中的体现

**位置**: 个股分析 → AI分析Tab → 行业轮动面板

**显示内容**:
- 💪 强势行业 TOP 10: 进度条显示各行业得分
- 📉 弱势行业 BOTTOM 10: 进度条显示各行业得分
- 所属行业: 高亮显示当前股票所在行业的排名

---

### 7.5 智能风控升级

#### 传统风控的不足

Phase 9及之前的风控体系:
- 固定百分比止损(如-8%): 不考虑股票波动率差异
- 单一持仓风险: 没有组合层面的相关性监控
- 黑天鹅滞后: 只有事后统计,缺乏实时预警

#### Phase 10 三大风控增强

##### (1) ATR自适应止损

**核心理念**: 根据股票的**历史波动率(ATR)**动态调整止损幅度,而非固定百分比。

**ATR (Average True Range)**:
- 衡量股票"日常波动幅度"的指标
- 计算: 过去14天的 `max(最高-最低, |最高-昨收|, |最低-昨收|)` 的均值

**止损逻辑**:
```python
from src.trading.risk import ATRStopLoss

atr_stop = ATRStopLoss(multiplier=2.0, atr_period=14)
stop_info = atr_stop.get_stop_info(df, entry_price=150.0)

# 返回:
# {
#   'atr': 3.2,              # 14日ATR值
#   'stop_price': 143.6,     # 止损价 = 150 - (3.2 × 2.0)
#   'stop_pct': -0.0427,     # -4.27% (动态)
#   'method': 'atr'
# }
```

**对比**:
- 传统固定止损: 所有股票统一-8%
- ATR自适应:
  - 高波动股(ATR=5): 止损-6.7% (放宽,避免被正常波动震出)
  - 低波动股(ATR=1.5): 止损-2% (收紧,低波动股不该大跌)

**降级**: 数据不足时回退到8%固定止损

##### (2) 持仓相关性监控

**核心理念**: 检测持仓中高度相关的股票对,避免"看似分散,实则集中"的伪分散化。

**示例场景**:
- 用户持有: AAPL, MSFT, NVDA, AMD, INTC (5只科技股)
- 看似5只股票,实则都是科技行业,相关性>0.85
- 市场风险: 科技板块一旦调整,5只同时下跌,组合回撤巨大

**监控指标**:

```python
from src.trading.risk import CorrelationMonitor

monitor = CorrelationMonitor(lookback=60, warning_threshold=0.8)

# 输入: 各股票的60日价格序列
price_data = {
    'AAPL': df_aapl['close'],
    'MSFT': df_msft['close'],
    'NVDA': df_nvda['close'],
}

# (1) 相关性矩阵
corr_matrix = monitor.calculate_correlation_matrix(price_data)
#       AAPL  MSFT  NVDA
# AAPL  1.00  0.87  0.79
# MSFT  0.87  1.00  0.75
# NVDA  0.79  0.75  1.00

# (2) 高相关对
pairs = monitor.get_high_correlation_pairs(price_data)
# 返回: [('AAPL', 'MSFT', 0.87)]  # 相关性>0.8的组合

# (3) 分散化得分
score = monitor.get_diversification_score(price_data)
# 返回: 43.2 / 100  (平均相关性0.80 → 分散化较差)
```

**风险预警**:
- 相关性 > 0.8: 黄色警告 "AAPL与MSFT高度相关(0.87),考虑减持其一"
- 相关性 > 0.9: 红色警告 "持仓过度集中于科技板块"
- 分散化得分 < 40: "组合分散化不足,建议增加不同行业持仓"

##### (3) 黑天鹅检测器

**核心理念**: 基于**3-sigma规则**,检测大盘是否出现统计学上的极端异常波动,触发紧急风控。

**3-sigma规则**:
- 正态分布下,99.7%的数据在 `均值 ± 3倍标准差` 范围内
- 超出3σ的事件发生概率<0.3%,属于"黑天鹅"

**检测逻辑**:

```python
from src.trading.risk import BlackSwanDetector

detector = BlackSwanDetector(lookback=252, z_threshold=3.0)
result = detector.check(index_df)  # 输入大盘指数数据

# 返回:
# {
#   'triggered': True,
#   'severity': 'critical',      # none / warning / critical
#   'z_score': -4.7,             # 今日收益率是历史均值的-4.7倍标准差
#   'return': -0.065,            # 今日跌-6.5%
#   'historical_mean': 0.0003,
#   'historical_std': 0.014,
#   'message': "检测到极端市场波动! 今日跌幅-6.50%,为历史均值-4.7倍标准差(>3σ临界值)"
# }
```

**分级响应**:
- `z_score ≥ 4.5σ`: **critical** (0.001%概率事件)
  - 紧急动作: "暂停所有买入信号"、"触发全组合止损检查"、"减仓至现金比例≥50%"
- `z_score ≥ 3.0σ`: **warning** (0.3%概率事件)
  - 谨慎动作: "买入信号强度降低50%"、"新建仓位规模减半"、"提高止损优先级"

**界面展示**:
- AI分析Tab → 智能风控面板 → 黑天鹅预警(最高优先级,红色/橙色背景)
- 持仓管理 → 调仓计划 → 自动附加"市场处于危机状态,建议暂缓新建仓"

#### 风控面板综合展示

**位置**: 个股分析 → AI分析Tab → 智能风控面板

**内容**:
1. 🚨 黑天鹅预警 (最上方,critical时红色背景)
2. ⚠️ 基础风险告警 (原有风控模块的输出)
3. 📏 ATR自适应止损
   - ATR值、止损价、止损幅度
4. 🔗 持仓相关性监控
   - 高相关股票对列表
   - 分散化得分

---

### 7.6 深度学习信号过滤

#### 它是什么？

将Phase 9训练好的**LSTM/Transformer深度学习模型**作为策略信号的"二次验证过滤器",实现AI与量化策略的协同决策。

#### 设计原则

- **DL作为辅助,非主导**: 只做否决(veto)不做生成
- **过滤逻辑**:
  - 策略说买入 + DL预测上涨 → ✅ 保持买入
  - 策略说买入 + DL预测下跌 → ⚠️ 降级为持有
  - 策略说卖出 + DL预测下跌 → ✅ 保持卖出
  - 策略说卖出 + DL预测上涨 → ⚠️ 降级为持有
- **置信度门槛**: DL预测置信度 < 60% 时不过滤(避免误伤)
- **优雅降级**: 模型不可用时自动跳过,不影响策略运行

#### 工作流程

```python
from src.models.dl_signal_filter import DLSignalFilter

# 1. 初始化过滤器(自动加载最新模型)
dl_filter = DLSignalFilter(
    model_dir="data/models",
    enabled=True,
    confidence_threshold=0.6
)

# 2. 策略生成原始信号
report = strategy.analyze_stock(code, df, ...)
# report.action = "buy", report.confidence = 75.0

# 3. DL过滤
result = dl_filter.filter_signal(
    action="buy",
    code=code,
    factored_df=factored_df,  # 已计算因子的DataFrame
    confidence=75.0
)

# 4. 过滤结果
# {
#   'action': 'hold',            # 买入被降级为持有
#   'confidence': 37.5,          # 置信度减半
#   'dl_prediction': -0.032,     # DL预测未来下跌-3.2%
#   'dl_confidence': 0.78,       # DL预测置信度78%
#   'filtered': True,
#   'reason': "DL预测下跌-3.20%,买入信号被否决"
# }
```

#### 模型加载机制

```python
# 扫描 data/models/ 目录
model_files = [
    "lstm_20250218_acc0.67.pth",
    "transformer_20250215_acc0.71.pth",
]

# 按修改时间排序,取最新
latest_model = "transformer_20250215_acc0.71.pth"  # ← 自动加载此模型

# 加载配套文件
# - transformer_scaler.pkl (归一化器)
# - transformer_features.txt (特征列表)
```

**降级**: 未找到模型文件时,`enabled=False`,所有过滤调用直接返回原始信号。

#### 预测逻辑

**输入特征**: 最近10天的因子值 (与Phase 9训练时一致)
- 技术面: RSI, MACD, 布林带, 波动率, 成交量
- 基本面: PE, PB, ROE, 营收增长
- 共10-15个特征

**输出**: 未来5日收益率预测
- 示例: `prediction = 0.025` → 预测上涨2.5%
- 置信度估算: `abs(prediction) / 0.05`, 预测幅度越大置信度越高

#### 过滤阈值

| DL预测 | 策略原始信号 | 过滤后信号 | 置信度调整 |
|--------|------------|-----------|-----------|
| 下跌 > 1% | 买入 | **持有** | × 0.5 |
| 下跌 0-1% | 买入 | 买入 | × 0.8 (减弱) |
| 上涨 | 买入 | 买入 | × 1.1 (确认) |
| 上涨 > 1% | 卖出 | **持有** | × 0.5 |
| 上涨 0-1% | 卖出 | 卖出 | × 0.8 (减弱) |
| 下跌 | 卖出 | 卖出 | × 1.1 (确认) |

#### 在界面中的体现

**位置**: 个股分析 → AI分析Tab → 深度学习过滤器 (可折叠面板)

**显示内容**:
- 模型类型: LSTM / Transformer
- 特征数量: 12
- 置信阈值: 60%
- 状态: ✅ 运行中 / ❌ 未启用

**在决策报告中**:
```
决策: 持有 (置信度 38%)

推理过程:
- [原策略] 多因子均衡策略建议买入(置信度75%)
- ⚠️ DL预测下跌-3.20%,买入信号被否决
- 🤖 深度学习过滤器: Transformer模型(置信度78%)认为短期有下行风险
```

---

### Phase 10 总结

| 模块 | 核心价值 | 数据来源 | 成本 |
|------|---------|---------|------|
| Grok AI情绪 | 补全社交媒体情绪维度 | X平台 + xAI API | $5/天(可调) |
| 行研报告共识 | 整合华尔街分析师观点 | yfinance (免费) / AKShare (免费) | 免费 |
| HMM市场状态 | 宏观周期识别,自适应调整策略 | 指数行情 (免费) | 免费 |
| 行业轮动 | 行业维度增益/惩罚 | AKShare / Sector ETF (免费) | 免费 |
| 智能风控 | ATR/相关性/黑天鹅三重保护 | 历史行情 (免费) | 免费 |
| DL信号过滤 | AI与量化协同决策 | 本地模型 (Phase 9训练) | 免费 |

**权重控制**:
- 单一外部因子 ≤ 10%
- 所有外部因子合计 ≤ 25%
- 核心决策仍基于价量+基本面

**优雅降级**:
- 所有Phase 10模块均可独立禁用
- 数据不可用时自动跳过,不影响核心策略运行

---

## 8. 数据驱动工作台：5步流水线

> **核心目的**：用真实市场数据训练和优化策略参数，替代人为"拍脑袋"设定参数

### 为什么需要这个？

系统的6大策略默认使用"人工经验设定"的参数（比如各因子的权重、买卖阈值）。但人工设定可能不是最优的。数据驱动工作台通过以下5步，用数据"说话"，找到更好的参数：

### Step 1：批量下载训练数据

**做什么**：从市场上下载大量股票的历史数据，作为后续分析的数据基础。

**操作步骤**：
1. 选择市场：US（美股）或 CN（A股）
2. 选择股票池：
   - 美股：S&P 500前100只 / S&P 500全量~500只 / 默认精选30只
   - A股：A股精选40只 / 默认精选30只
3. 设置历史年数（3-15年）
4. 点击"开始下载"

**注意事项**：
- 系统会自动跳过已经下载过的股票（避免重复下载）
- 下载完成后会显示已缓存数据的概览表
- 如果之前已经下载过，可以点击"直接加载已有缓存"跳过下载
- A股数据源有时会超时，系统会自动在30秒后跳过并使用已有缓存

**通俗理解**：就像做学术研究前先收集大量样本数据。

---

### Step 2：因子有效性验证

**做什么**：检验每个"因子"（评分指标）到底有没有预测未来涨跌的能力。

**核心概念**：
- **IC（信息系数）**：把所有股票按某个因子值排序，再按未来实际涨跌排序，看这两个排序有多相似。相似度高说明这个因子能预测未来涨跌。
- **IC_IR（信息比率）**：IC的平均值 / IC的标准差。不仅看预测准不准，还看预测稳不稳定。

**因子评级标准**：
| IC_IR 绝对值 | 评级 | 含义 |
|-------------|------|------|
| ≥ 0.5 | 强有效 | 预测能力强且稳定，值得给高权重 |
| 0.3 ~ 0.5 | 中等有效 | 有一定预测能力，可以使用 |
| 0.1 ~ 0.3 | 弱有效 | 预测能力较弱，权重应该低 |
| < 0.1 | 无效 | 基本没有预测能力，可以考虑剔除 |

**通俗理解**：就像考试前复习——先看看哪些"知识点"（因子）真的有用，哪些是"无用功"。

---

### Step 3：权重优化

**做什么**：根据Step 2的验证结果，重新设定每个因子的权重。

**两种方法**：

| 方法 | 通俗解释 | 优点 | 缺点 |
|------|---------|------|------|
| **IC_IR加权** | 验证分数高的因子，给更大的权重。就像考试中"分值高的题目花更多时间"。 | 简单直观、不易过拟合 | 可能不是全局最优 |
| **随机搜索最大夏普** | 随机尝试200种不同的权重组合，找出回测中夏普比率最高的那组。 | 能找到更优的组合 | 有过拟合风险 |

**独立运行**：每个策略可以独立选择一种方法进行优化。不需要把6个策略都优化完才能进入Step 4——每个策略的优化是独立的。

**操作步骤**：
1. 选择目标策略（如"动量趋势"）
2. 选择优化方法
3. 点击"开始优化"
4. 优化后的权重自动保存到配置文件

**通俗理解**：就像调音师调整各个乐器的音量比例，让整体效果最好。

---

### Step 4：阈值网格搜索

**做什么**：找到最佳的"买入分数线"和"卖出分数线"。

**核心问题**：策略给每只股票打出一个综合分（0-100），多少分以上该买入？多少分以下该卖出？

**操作步骤**：
1. 选择策略
2. 设定搜索范围：
   - 买入阈值范围：50-80（在这个范围内搜索）
   - 卖出阈值范围：20-50
   - 步长：5（每隔5分测试一次）
3. 点击"开始搜索"

**系统会做什么**：测试所有可能的（买入阈值, 卖出阈值）组合，用历史数据模拟交易，选出夏普比率最高的那组。

**示例**：
- 测试组合 (55, 25)：买入阈值55，卖出阈值25 → 夏普 0.8
- 测试组合 (60, 30)：买入阈值60，卖出阈值30 → 夏普 1.2
- 测试组合 (65, 35)：买入阈值65，卖出阈值35 → 夏普 1.1
- **最佳**: (60, 30)，夏普最高

**通俗理解**：就像设定一个"录取分数线"——太低了会录取太多"差生"（买入太多差股票），太高了又会错过"好学生"（错过好机会）。通过穷举找到最佳分数线。

---

### Step 5：配置管理与再训练

**做什么**：查看和管理所有优化结果，以及一键重新训练。

**包含功能**：
1. **当前配置查看**：显示每个策略的权重、阈值、数据来源（人工设定 vs 数据优化）
2. **信号日志统计**：
   - 总信号数、近30天信号数
   - 5天胜率（系统建议买入后5天内实际上涨的比例）
   - 各策略信号分布（买入/卖出/持有的次数）
3. **一键再训练**：自动依次执行 Step2 → Step3 → Step4，全流程重新优化
4. **训练历史记录**：所有步骤的历史训练记录，包括时间、方法、结果

**什么时候需要再训练**：
- 市场风格发生明显变化时（如从牛市转熊市）
- 信号日志显示近期胜率明显下降时
- 每隔1-3个月定期再训练一次

---

## 9. 从数据到交易：系统如何帮你买卖股票

这一章解释系统的完整工作流程——从原始数据到最终的买卖决策。

### 整体流程

```
原始数据 → 因子计算 → 策略打分 → 买卖信号 → 持仓管理
   ↑                                              |
   └──────── 数据驱动优化（反馈循环）←─────────────┘
```

### 第一层：数据收集（Step 1）

系统从公开数据源获取每只股票的：
- 每日行情：开盘价、最高价、最低价、收盘价、成交量
- 基本面数据（如有）：市盈率PE、市净率PB、ROE等
- 宏观数据：GDP增长率、CPI、利率等

### 第二层：因子计算

系统从原始数据中计算出50多个"因子"（评价指标），分为6大类：
- **技术面**：动量、RSI、MACD、均线等 → 告诉你"趋势"
- **波动/风险**：波动率、下行风险、ATR → 告诉你"风险有多大"
- **成交量**：量比、换手率 → 告诉你"市场活跃度"
- **基本面**：PE、PB、ROE → 告诉你"公司好不好"
- **宏观**：GDP、CPI、利率 → 告诉你"大环境如何"
- **情绪**：VIX、北向资金 → 告诉你"市场情绪"

### 第三层：策略打分

每个策略拿到因子值后，按照自己的权重计算综合得分（0-100分）：

```
综合得分 = 因子1 × 权重1 + 因子2 × 权重2 + ... + 因子N × 权重N
```

### 第四层：买卖决策

```
如果 综合得分 ≥ 买入阈值（如65）→ 发出"买入"信号
如果 综合得分 ≤ 卖出阈值（如35）→ 发出"卖出"信号
否则 → 发出"持有"信号
```

### 第五层：风险控制

即使策略说"买入"，系统还会检查：
- 单只股票仓位是否超过总资金的10%？
- 同一行业是否已经持有太多？
- 是否触发了止损线？
- 整体仓位的VaR（最大可能亏损）是否在承受范围内？

### 第六层：信号跟踪与反馈

每次发出信号后，系统会：
1. 记录信号详情（时间、股票、策略、方向、得分、当时价格）
2. 在5天、10天、20天后回填实际收益
3. 统计胜率，评估策略效果
4. 如果效果不理想 → 用户可以通过"数据驱动工作台"重新训练优化

### 实际操作建议

| 步骤 | 操作 | 频率 |
|------|------|------|
| 1. 数据更新 | 在"数据驱动工作台"Step 1下载最新数据 | 每月1次 |
| 2. 优化参数 | 执行Step 2-4或一键再训练 | 每1-3个月 |
| 3. 每日决策 | 在"个股分析"中查看持仓股票的信号 | 每天 |
| 4. 市场扫描 | 在"市场扫描"中发现新机会 | 每周1-2次 |
| 5. 持仓管理 | 在"持仓管理"中查看调仓建议 | 每周 |
| 6. 定期复盘 | 查看"信号日志"评估策略效果 | 每周/每月 |

---

## 10. 专业术语通俗解释

按字母顺序排列：

### A

**ADX（平均趋向指数）**
衡量趋势的"强弱程度"（不管涨跌方向）。ADX>25表示趋势强，<20表示震荡。就像衡量"风力大不大"，不管是顺风还是逆风。

**Alpha（阿尔法）**
你的策略收益超过大盘的部分。Alpha=5%意味着策略比大盘多赚了5%。这是衡量"你的选股能力值多少钱"。

**ATR（平均真实波幅）**
衡量股票每天价格波动的平均幅度。ATR越大，每天涨跌的幅度越大。🆕 Phase 10用于智能风控：基于ATR动态调整止损幅度，高波动股放宽止损，低波动股收紧止损。

### B

**Beta（贝塔）**
你的策略跟着大盘涨跌的程度。Beta=1 表示和大盘同步；Beta=1.5 表示大盘涨1%你涨1.5%（反之亦然）；Beta=0.5 表示波动只有大盘的一半。

**Bollinger Bands（布林带）**
围绕均线画出的上下两条"通道线"。股价触及上轨可能超买，触及下轨可能超卖。

### C

**CAGR（复合年增长率）**
考虑复利效应的年化收益率。1万元经过3年变成1.5万，CAGR≈14.5%。

**Calmar比率**
年化收益率 / 最大回撤。衡量"你赚到的钱能不能弥补最大的亏损"。

**Correlation（相关系数）**
🆕 衡量两只股票价格走势的相似程度。相关系数=0.9表示高度同步，=0表示无关，=-1表示完全相反。Phase 10持仓相关性监控：检测相关性>0.8的持仓对，避免伪分散化风险。

**CVaR（条件风险价值）**
"如果发生了最坏的5%情况，平均会亏多少"。比VaR更悲观的风险衡量。

### D

**DCA（定期定额投资法）**
Dollar Cost Averaging。每隔固定时间投入固定金额。"不管涨跌都买"——跌多了多买入份额，涨多了少买入份额，长期拉低平均成本。

### F

**Fama-French三因子模型**
学术金融中最著名的模型之一，认为股票收益由三个因素解释：
1. 市场风险（大盘涨跌）
2. 公司大小（小公司往往比大公司涨得多）
3. 价值因素（便宜的股票往往比贵的涨得多）

### H

**HMM（隐马尔可夫模型）**
🆕 Hidden Markov Model。Phase 10核心技术之一。假设市场有若干"隐藏状态"(如牛市/熊市/震荡/危机)，每个状态有不同的收益率分布特征，通过历史数据学习状态转移概率，推断当前市场最可能处于哪个状态，据此自适应调整策略权重。

**HML（高减低）**
High Minus Low。价值型股票收益减去成长型股票收益。如果HML>0，说明这段时间"便宜的股票比贵的涨得好"。

### I

**IC（信息系数）**
Information Coefficient。衡量一个因子预测未来涨跌的准确度。IC=0.05表示有一定预测能力，IC=0 表示完全没用。

**IC_IR（信息比率）**
IC的均值 / IC的标准差。不仅看预测"准不准"，还看"稳不稳"。IC_IR>0.5是很好的因子。

**IRR（内部收益率）**
考虑了每笔投入时间的真实年化收益率，是衡量定投效果最准确的指标。

### K

**K线图（蜡烛图）**
显示股价走势的经典图表。每根"蜡烛"代表一天：
- 红色（阳线）：收盘价 > 开盘价（涨了）
- 绿色（阴线）：收盘价 < 开盘价（跌了）
- 上下的"影线"表示当天的最高价和最低价

### M

**MA（均线）**
Moving Average。把过去N天的收盘价取平均值，连成一条线。
- MA5：5天均线，反映近一周趋势
- MA20：20天均线，反映近一个月趋势
- MA60：60天均线，反映近三个月趋势
- 当短期均线上穿长期均线 = "金叉"（看涨信号）
- 当短期均线下穿长期均线 = "死叉"（看跌信号）

**MACD**
由DIF线（快线）和DEA线（慢线）及柱状图组成的趋势指标：
- 柱状图变红变长 = 上涨力度增强
- 柱状图变绿变长 = 下跌力度增强
- 金叉（DIF上穿DEA）= 买入信号
- 死叉（DIF下穿DEA）= 卖出信号

**Max Drawdown（最大回撤）**
从历史最高点到最低点的最大跌幅。比如最高赚了100万，然后跌到只赚了70万，最大回撤就是30%。这个指标衡量的是"最惨的时候你会亏多少"。

### P

**PE（市盈率）**
Price / Earnings。股价除以每股收益。PE=20意味着按当前盈利水平，需要20年才能"回本"。
- PE<15：通常被认为低估（便宜）
- PE>30：通常被认为高估（贵）

**PB（市净率）**
Price / Book Value。股价除以每股净资产。PB<1表示股价低于公司的"清算价值"。

### R

**ROE（净资产收益率）**
Return on Equity。公司用股东投入的钱赚了多少回报。ROE=15%意味着每100元股东资金一年赚15元。
- ROE>15%：优秀
- ROE>10%：良好
- ROE<5%：较差

**RSI（相对强弱指数）**
衡量股票在一段时间内的涨跌力度对比（0-100）：
- RSI > 70：超买——涨太多了，可能要回调
- RSI < 30：超卖——跌太多了，可能要反弹
- RSI = 50：中性

### S

**Sharpe Ratio（夏普比率）**
(策略收益 - 无风险收益) / 策略波动率。通俗理解：每承受1份风险能获得多少回报。
- < 0：亏钱
- 0-1：收益不够补偿风险
- 1-2：不错
- \> 2：非常优秀

**SMB（小减大）**
Small Minus Big。小盘股收益减去大盘股收益。如果SMB>0，说明这段时间小公司比大公司表现好。

**Sortino比率**
和夏普比率类似，但只考虑下行风险（亏钱方向的波动）。更合理，因为上涨的波动对投资者来说不是"坏事"。

**Stop Loss（止损）**
预设的最大亏损底线。比如止损线设为-8%，当你的持仓亏损达到8%时，系统建议你卖出止损，防止亏更多。

### T

**Tracking Error（跟踪误差）**
你的策略和基准（如沪深300）收益差异的波动率。跟踪误差越小，策略越贴近基准。

### V

**VaR（风险价值）**
Value at Risk。"在95%的情况下，一天/一个月最多亏多少"。比如日VaR=2%意味着95%的交易日亏损不超过2%。

**VIX（恐慌指数）**
衡量美股市场的恐慌程度。VIX>30表示市场非常恐慌，VIX<15表示市场非常平静。

**Volume Ratio（量比）**
今天的成交量 / 过去5天的平均成交量。量比>1.5表示"放量"——交易比平时活跃得多，可能意味着有重要的事情在发生。

### W

**Walk-Forward（滚动验证）**
不是简单地在全部历史数据上测试策略，而是：
1. 用前3年数据训练
2. 用第4年数据测试
3. 向前滚动：用前4年训练，第5年测试
4. 多次重复

这样做更接近真实情况（你永远只能用过去的数据预测未来），能有效防止"过拟合"（在历史数据上表现好但实战中不行）。

---

## 11. 常见问题 FAQ

### 🆕 Phase 10 AI增强功能相关

#### Q: 如何启用Grok AI分析？

**A**:
1. 注册xAI账号获取API Key: https://console.x.ai/
2. 设置环境变量: `export XAI_API_KEY="xai-xxxxx"` (或在`.env`文件中设置)
3. 修改 `config/settings.yaml`:
   ```yaml
   grok:
     enabled: true
     max_daily_cost_usd: 5.0  # 每日预算，可根据需求调整
   ```
4. 重启系统，在"个股分析 → AI分析Tab"查看结果

#### Q: Grok分析需要多少费用？

**A**:
- 默认每日预算上限: $5 USD
- 实际消耗: 单次个股情绪分析~$0.01-0.02 (使用grok-3-mini), 深度分析~$0.10-0.15 (使用grok-4-1)
- 多级缓存: 个股情绪4小时、市场情绪1小时、深度分析24小时，大幅减少重复调用
- 典型日常使用: 分析10只股票/天，约$0.2-0.5/天

#### Q: 不启用Grok AI，系统还能正常工作吗？

**A**: 完全可以。所有Phase 10模块都采用"优雅降级"设计:
- Grok API不可用或未启用时，自动跳过AI情绪因子
- 6大策略仍基于核心价量+基本面因子运行
- 决策质量会略微下降(缺失社交情绪维度)，但不影响系统整体可用性

#### Q: 行研报告数据从哪来？准确吗？

**A**:
- **美股**: yfinance内置的`ticker.recommendations`等API，数据来自Bloomberg/Reuters等主流金融数据商，覆盖Goldman Sachs、Morgan Stanley、J.P. Morgan等顶级投行
- **A股**: AKShare免费API，数据质量相对美股较弱，仅作辅助参考
- **准确性**: 行研数据本身是真实的(分析师确实给出了这些评级)，但分析师预测的准确率通常在50-60%左右，且存在"卖方偏差"(系统性偏乐观)。Phase 10已对此做偏差修正。

#### Q: HMM市场状态识别准吗？跟人工判断有什么区别？

**A**:
- **准确率**: 回测数据显示HMM识别准确率约70-80%(相比人工判断的60-70%)
- **优势**:
  1. 客观量化,不受情绪影响
  2. 自动学习历史状态转移规律
  3. 给出置信度而非绝对判断
- **局限**:
  1. 依赖历史数据,对"未见过"的市场环境可能误判
  2. 数据不足时降级到规则引擎(退化为传统技术指标)
- **建议**: 结合HMM识别结果和人工判断综合决策

#### Q: ATR自适应止损会不会比固定止损更容易被震出？

**A**: 不会，反而更合理:
- **高波动股** (如科技股): ATR=5, 止损放宽到-6.7%，避免被正常波动震出
- **低波动股** (如公用事业): ATR=1.5, 止损收紧到-2%，低波动股不该大跌
- **对比固定止损**: 统一-8%会导致高波动股过早止损(错失反弹),低波动股止损过晚(扩大亏损)
- **回测验证**: ATR自适应止损使夏普比率提升约15%

#### Q: 深度学习信号过滤会不会误杀好信号？

**A**: 设计上已最大限度避免:
1. **置信度门槛**: DL预测置信度<60%时不过滤(避免不确定预测误伤)
2. **只做否决不做生成**: 只会降级信号(buy→hold)，不会凭空产生信号
3. **渐进式过滤**:
   - DL预测下跌>1% → 完全否决
   - DL预测下跌0-1% → 仅减弱信号强度(×0.8)
   - DL预测上涨 → 确认信号(×1.1)
4. **可关闭**: 在`dl_signal_filter.py`中设置`enabled=False`即可禁用
5. **回测数据**: 启用DL过滤后胜率提升3-5%，但交易次数减少约20%(过滤掉了部分低质量信号)

#### Q: Phase 10 这么多外部因子，会不会导致策略过度复杂、过拟合？

**A**: 已做严格权重控制:
- **单一外部因子权重上限**: 10%
- **所有外部因子合计上限**: 25% (均衡策略10%，价值策略15%)
- **核心仍是价量+基本面**: 75%权重仍基于技术面(50%)+财务面(25%)
- **降级测试**: 关闭所有Phase 10模块后，6大策略仍能正常工作，性能下降<10%
- **防过拟合措施**: 行研/HMM/行业轮动基于实时市场数据(非历史拟合)，DL模型使用Walk-Forward验证

### 基础功能相关

#### Q: 系统推荐"买入"就一定要买吗？

**A**: 不是。系统的建议是基于数学模型和历史数据的参考意见，不是交易指令。你应该结合自己的判断、资金情况、风险承受能力来做最终决策。没有任何系统能保证100%盈利。

#### Q: 多个策略给出不同的建议怎么办？

**A**: 这很正常。不同策略从不同角度分析：
- 如果大多数策略都说"买入"→ 信号较强
- 如果有的说买有的说卖 → 信号不明确，建议观望
- 可以使用"策略实验室"中的"策略集成"功能，让多个策略投票或加权得出综合意见

#### Q: 应该优先相信哪个策略？

**A**: 取决于当前的市场环境。可以使用"智能策略路由器"（在个股分析中选择"自动推荐"），系统会根据当前市场状态自动推荐最适合的策略。

#### Q: 回测效果好 = 未来也会赚钱吗？

**A**: 不一定。回测有"幸存者偏差"和"过拟合"风险。系统的Walk-Forward验证可以减轻这个问题，但无法完全消除。建议：
- 回测结果好是必要条件但不是充分条件
- 关注信号日志中"实际胜率"的变化
- 定期用数据驱动工作台重新训练

#### Q: 数据驱动工作台的5步必须全部完成吗？

**A**: 不必须。
- **最低要求**：完成Step 1（下载数据）后就可以正常使用系统的其他功能
- **推荐做法**：完成Step 1-4可以显著提升策略效果
- **每个策略独立**：不需要把6个策略全部优化完才能用
- **一键再训练**：Step 5提供了一键完成2-4步的快捷方式

#### Q: Step 3 中两种优化方法怎么选？

**A**:
- **IC_IR加权**：更稳健，不容易过拟合，推荐初次使用或数据量不大时使用
- **随机搜索最大夏普**：可能找到更好的结果，但有过拟合风险，推荐有大量数据（>100只股票、>5年）时使用

#### Q: 下载数据需要多长时间？

**A**: 取决于股票数量和网络状况：
- 美股30只，约2-5分钟
- 美股100只，约5-15分钟
- A股40只，约5-10分钟（偶尔因数据源限制可能超时，系统会自动重试或跳过）

#### Q: A股数据下载经常超时怎么办？

**A**: A股使用的免费数据源（AKShare）有时会不稳定。系统会：
- 对每只股票设置30秒超时保护
- 超时后自动使用已有缓存
- 你可以稍后再次尝试下载失败的股票

#### Q: 如何判断我的策略参数需要更新？

**A**: 以下情况建议重新训练：
- 信号日志中近30天胜率明显下降（低于45%）
- 市场风格发生明显变化（如从震荡市转为趋势市）
- 距离上次训练已经超过3个月
- 切换了不同的市场（从A股切到美股）

#### Q: 系统需要联网吗？

**A**: 首次使用需要联网下载股票数据。一旦数据缓存到本地数据库，大部分分析功能可以离线使用。但以下功能需要联网：
- 下载新数据或更新数据
- 获取实时价格
- 获取基本面数据更新

---

> **免责声明**：本系统仅供学习和研究使用，不构成投资建议。股市有风险，投资需谨慎。所有交易决策应基于您自己的判断和风险承受能力。
